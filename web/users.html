<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Users - OLDRBX</title>
<link rel="icon" href="/img/ic.png">
<style>
:root{--bg:#efefef;--panel:#ffffff;--muted:#666;--border:#d7d7d7;--accent:#111}
html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111}
.topbar{height:56px;background:var(--accent);display:flex;align-items:center;padding:0 12px;gap:12px}
.hamburger{width:44px;height:44px;border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer}
.logo-img{height:32px}
.top-right{margin-left:auto;display:flex;align-items:center;gap:12px}
.money-wrap{display:flex;align-items:center;gap:8px;color:#fff;font-weight:800}
.money-wrap img{width:20px;height:20px}
.balance{font-weight:800;color:#fff}
.avatar{width:36px;height:36px;border-radius:6px;overflow:hidden;background:#fff;display:inline-block}
.avatar img{width:100%;height:100%;object-fit:cover}
.container{max-width:1100px;margin:20px auto;padding:0 16px}
.layout{display:grid;grid-template-columns:300px 1fr;gap:18px;align-items:start}
.sidebar{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:6px}
.user-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.user-header .mini{width:44px;height:44px;border-radius:6px;overflow:hidden}
.user-header .mini img{width:100%;height:100%;object-fit:cover}
.username{font-weight:900}
.nav-item{padding:12px;border-radius:6px;background:#fff;border:1px solid var(--border);font-weight:800;margin-bottom:10px;cursor:pointer}
.main{background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:6px}
.section-title{font-weight:900;margin-bottom:8px}
.user-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;background:#fff}
.user-left{display:flex;align-items:center;gap:10px}
.user-left img{width:48px;height:48px;border-radius:6px;object-fit:cover;flex-shrink:0}
.status-online{color:green;font-weight:800}
.status-off{color:var(--muted)}
.btn{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#fff;font-weight:800;cursor:pointer}
.empty{color:var(--muted);padding:12px;text-align:center}
.footer{margin-top:18px;background:var(--panel);border-top:1px solid var(--border);padding:10px 16px;color:var(--muted);font-weight:700;text-align:center}
@media(max-width:1000px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;left:-360px;top:56px;height:calc(100% - 56px);width:280px;z-index:1200;transition:left .18s ease}.sidebar.open{left:0}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger">&#9776;</button>
  <img src="/img/logo.png" class="logo-img" alt="logo">
  <div class="top-right">
    <div class="money-wrap" title="Balance">
      <img id="moneyIcon" src="/img/money.png" alt="money">
      <div id="balanceText" class="balance">0</div>
    </div>
    <a id="topAvatar" class="avatar" href="/web/home.html"><img id="topAv" src="/img/user.png" alt="avatar"></a>
  </div>
</div>

<div class="container">
  <div class="layout">
    <aside id="sidebar" class="sidebar">
      <div class="user-header">
        <div class="mini"><img id="sideAv" src="/img/user.png" alt=""></div>
        <div><div id="sideName" class="username">User</div></div>
      </div>
      <div class="nav-item" data-h="/web/home.html">Home</div>
      <div class="nav-item" data-h="/web/friends.html">Friends</div>
      <div class="nav-item" data-h="/web/groups.html">Groups</div>
      <div class="nav-item" data-h="/web/forums.html">Forums</div>
      <div class="nav-item" data-h="/web/users.html">Users</div>
    </aside>
    <main class="main" role="main">
      <div class="section-title">Registered Users</div>
      <div id="usersList"></div>
    </main>
  </div>
  <div class="footer">Â© 2026 OLDRBX</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function formatLastSeen(dateStr){
  if(!dateStr) return "Never online";
  const date=new Date(dateStr);
  return "Last seen on "+date.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})+
         " at "+date.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});
}

document.addEventListener('DOMContentLoaded', async () => {
  const SUPA_URL="https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3R0ZmhtZWd5emVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQ5MTIsImV4cCI6MjA4NDI0MDkxMn0.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

  const hamb = document.getElementById('hamb');
  const sidebar = document.getElementById('sidebar');
  hamb.addEventListener('click', () => { if(window.innerWidth<1000) sidebar.classList.toggle('open') });
  document.querySelectorAll('.nav-item').forEach(it => it.addEventListener('click', () => location.href=it.dataset.h));

  let auth = null;
  try { auth = JSON.parse(localStorage.getItem('auth')) } catch(e){ auth=null }
  if(!auth||!auth.username){ location.replace('/web/login.html'); return }

  document.getElementById('sideName').innerText=auth.username;
  function safeSrc(u){ return u && u.trim() ? u : '/img/user.png' }
  function setAv(u){ const s=safeSrc(u); document.getElementById('sideAv').src=s; document.getElementById('topAv').src=s }
  setAv(auth.avatarUrl);
  document.getElementById('moneyIcon').src='/img/money.png';
  document.getElementById('balanceText').innerText=String(auth.balance??0);

  async function getUser(){
    const r = await sb.from('users').select('*').eq('username', auth.username).maybeSingle();
    return r.data || null;
  }
  const me = await getUser();
  if(me?.balance!=null) document.getElementById('balanceText').innerText=String(me.balance);
  if(me?.avatar_url) setAv(me.avatar_url);
  if(me?.id) await sb.from('users').update({last_active:new Date().toISOString()}).eq('id', me.id);

  const list = document.getElementById('usersList');
  list.innerHTML='<div class="empty">Loading users...</div>';

  try {
    const r = await sb.from('users').select('id,username,avatar_url,balance,last_active,registered_on');
    if(!r.data||!r.data.length){ list.innerHTML='<div class="empty">No registered users</div>'; return; }

    let users = r.data.map(u => {
      let diff = u.last_active ? (Date.now() - new Date(u.last_active).getTime())/1000 : Infinity;
      u.online = diff < 60;
      u.last_seen_seconds = diff;
      return u;
    });

    users.sort((a,b) => {
      if(a.online && !b.online) return -1;
      if(!a.online && b.online) return 1;
      return a.last_seen_seconds - b.last_seen_seconds;
    });

    list.innerHTML='';
    for(const u of users){
      const row=document.createElement('div'); row.className='user-row';
      const left=document.createElement('div'); left.className='user-left';
      const av=document.createElement('img'); av.src=safeSrc(u.avatar_url);
      const info=document.createElement('div');
      info.innerHTML=`<div style="font-weight:800">${u.username}</div>
        <div style="font-size:12px;color:var(--muted)">Registered: ${u.registered_on?new Date(u.registered_on).toLocaleDateString("en-US"):''}</div>
        <div style="font-size:12px;color:var(--muted)">Balance: ${u.balance??0}</div>`;
      left.appendChild(av); left.appendChild(info);

      const right=document.createElement('div');
      const status=document.createElement('div');
      if(u.online){ status.className='status-online'; status.innerText='Online' }
      else{ status.className='status-off'; status.innerText=formatLastSeen(u.last_active) }
      const btn=document.createElement('button');
      btn.className='btn'; btn.innerText='View';
      btn.addEventListener('click',()=>location.href='/web/home.html?u='+u.id);
      right.appendChild(status); right.appendChild(btn);

      row.appendChild(left); row.appendChild(right);
      list.appendChild(row);
    }
  } catch(e) {
    list.innerHTML='<div class="empty">Error loading users</div>';
  }

  window.addEventListener('resize',()=>{if(window.innerWidth>=1000) sidebar.classList.remove('open')});
});
</script>
</body>
</html>