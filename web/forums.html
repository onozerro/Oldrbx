<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forums - OLDRBX</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="img/ic.png">
<style>
:root{--bg:#121316;--panel:#1e2022;--border:#2b2d30;--muted:#b8b8b8;--accent:#98a3ad}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif}
.topbar{height:56px;background:var(--panel);border-bottom:2px solid var(--border);display:flex;align-items:center;padding:0 12px}
.hamburger{width:40px;height:40px;border-radius:6px;background:transparent;border:none;color:var(--muted);font-size:20px;display:none;order:0}
.logo-img{height:28px;order:1}
.container-layout{display:grid;grid-template-columns:300px 1fr;gap:18px;padding:18px}
.sidebar{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px}
.topic{padding:10px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.topic:hover{background:rgba(255,255,255,0.02)}
.topic.active{background:rgba(255,255,255,0.03);border-left:3px solid var(--accent)}
.mainpanel{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;min-height:420px;display:flex;flex-direction:column}
.posts{flex:1;overflow:auto;padding-right:6px}
.post{display:flex;gap:12px;padding:12px;border-radius:6px;border-bottom:1px solid var(--border);align-items:flex-start}
.post .avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;background:var(--border)}
.post .avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.post .body{flex:1}
.post .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
.composer{margin-top:12px;display:flex;gap:10px;align-items:flex-start}
.composer textarea{flex:1;min-height:90px;background:#111;border:1px solid var(--border);color:#fff;padding:10px;border-radius:6px;resize:vertical}
.composer button{height:40px;border-radius:6px}
.empty{color:var(--muted);padding:18px;text-align:center}
.footer{background:var(--panel);border-top:2px solid var(--border);padding:10px;text-align:center;color:var(--muted)}
@media(max-width:900px){.container-layout{grid-template-columns:1fr;padding:12px}.sidebar{order:2}.mainpanel{order:1}.hamburger{display:inline-flex}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger" aria-label="menu">&#9776;</button>
  <img src="img/logo.png" class="logo-img" alt="logo">
  <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
    <div class="avatar"><img id="topAv" src="img/user.png" style="width:36px;height:36px;border-radius:50%" alt="avatar"></div>
  </div>
</div>
<div class="container-layout">
  <aside class="sidebar" id="sidebar">
    <div style="font-weight:800;margin-bottom:8px">Forums</div>
    <div id="topicsList"></div>
  </aside>
  <section class="mainpanel">
    <div id="topicHeader" style="font-weight:800;margin-bottom:8px"></div>
    <div class="posts" id="postsList"></div>
    <div id="composerWrap" style="margin-top:12px;display:none">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Post as <span id="meName"></span></div>
      <div class="composer">
        <img id="meAv" src="img/user.png" style="width:48px;height:48px;border-radius:50%" alt="avatar">
        <textarea id="msgInput" placeholder="Write your message..."></textarea>
      </div>
      <div style="margin-top:8px;display:flex;justify-content:flex-end">
        <button id="sendBtn" class="btn btn-primary">Send</button>
      </div>
    </div>
  </section>
</div>
<footer class="footer">&copy; 2026 OLDRBX</footer>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPA_URL = "https://nkvvnnjukqtfhmegyzek.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3R0ZmhtZWd5emVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQ5MTIsImV4cCI6MjA4NDI0MDkxMn0.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);
let auth = null;
try{auth = JSON.parse(localStorage.getItem('auth'))}catch(e){auth=null}
if(!auth||!auth.username){location.replace('login.html')}
document.getElementById('meName').innerText = auth.username;
document.getElementById('meAv').src = auth.avatarUrl || 'img/user.png';
document.getElementById('topAv').src = auth.avatarUrl || 'img/user.png';
document.getElementById('hamb').addEventListener('click',function(){document.getElementById('sidebar').classList.toggle('open')});
document.querySelectorAll('.nav-item').forEach(it=>it.addEventListener('click',()=>location.href=it.dataset.h));
const topicsList = document.getElementById('topicsList');
const postsList = document.getElementById('postsList');
const topicHeader = document.getElementById('topicHeader');
const composerWrap = document.getElementById('composerWrap');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msgInput');
async function loadTopics(){
  topicsList.innerHTML = '<div class="empty">Loading topics...</div>';
  try{
    const res = await sb.from('forum_topics').select('id,title,slug').order('id',{ascending:true});
    if(res.error||!res.data||!res.data.length){
      const defaults = [{title:'News',slug:'news'},{title:'Updates',slug:'updates'},{title:"What's on your mind",slug:'whats-on-your-mind'}];
      topicsList.innerHTML = '';
      defaults.forEach((t,i)=>{const el=document.createElement('div');el.className='topic';el.innerText=t.title;el.dataset.slug=t.slug;el.addEventListener('click',()=>selectTopic(t.slug,t.title));topicsList.appendChild(el);if(i===0)selectTopic(t.slug,t.title)});
      return;
    }
    topicsList.innerHTML = '';
    res.data.forEach((t,i)=>{const el=document.createElement('div');el.className='topic';el.innerText=t.title;el.dataset.slug=t.slug||t.title.toLowerCase().replace(/\s+/g,'-');el.addEventListener('click',()=>selectTopic(el.dataset.slug,t.title));topicsList.appendChild(el);if(i===0)selectTopic(el.dataset.slug,t.title)});
  }catch(e){
    topicsList.innerHTML = '<div class="empty">Unable to load topics</div>';
  }
}
async function selectTopic(slug,title){
  currentSlug = slug;
  Array.from(document.querySelectorAll('.topic')).forEach(x=>x.classList.remove('active'));
  const clicked = [...document.querySelectorAll('.topic')].find(x=>x.dataset.slug===slug);
  if(clicked) clicked.classList.add('active');
  topicHeader.innerText = title;
  composerWrap.style.display = 'none';
  postsList.innerHTML = '<div class="empty">Loading posts...</div>';
  try{
    const r = await sb.from('forum_topics').select('id').eq('slug',slug).limit(1).maybeSingle();
    let topicId = null;
    if(r && r.data && r.data.id) topicId = r.data.id;
    else {
      const ins = await sb.from('forum_topics').insert({title:title,slug:slug}).select().maybeSingle();
      if(ins && ins.data && ins.data.id) topicId = ins.data.id;
    }
    if(!topicId){postsList.innerHTML = '<div class="empty">Unable to load posts</div>';return}
    const p = await sb.from('forum_posts').select('id,username,content,avatar_url,created_at').eq('topic_id',topicId).order('created_at',{ascending:true});
    if(p.error){postsList.innerHTML = '<div class="empty">Error loading posts</div>';return}
    postsList.innerHTML = '';
    if(!p.data||!p.data.length){postsList.innerHTML = '<div class="empty">No posts yet. Be the first to post.</div>';composerWrap.style.display='block';return}
    p.data.forEach(post=>{const d=document.createElement('div');d.className='post';const av=document.createElement('div');av.className='avatar';const img=document.createElement('img');img.src=post.avatar_url||'img/user.png';av.appendChild(img);const body=document.createElement('div');body.className='body';const meta=document.createElement('div');meta.className='meta';const date=new Date(post.created_at).toLocaleString();meta.innerText=post.username+' â€¢ '+date;const msg=document.createElement('div');msg.innerText=post.content;body.appendChild(meta);body.appendChild(msg);d.appendChild(av);d.appendChild(body);postsList.appendChild(d)});
    composerWrap.style.display='block';
    postsList.scrollTop = postsList.scrollHeight;
    currentTopicId = r && r.data && r.data.id ? r.data.id : (p.data[0] ? p.data[0].topic_id : null);
  }catch(e){
    postsList.innerHTML = '<div class="empty">Error loading posts</div>';
  }
}
let currentSlug = null;
let currentTopicId = null;
sendBtn.addEventListener('click',async function(){
  const txt = msgInput.value.trim();
  if(!txt) return;
  sendBtn.disabled = true;
  sendBtn.innerText = 'Sending...';
  try{
    if(!currentTopicId){
      const r = await sb.from('forum_topics').select('id').eq('slug',currentSlug).limit(1).maybeSingle();
      if(r && r.data && r.data.id) currentTopicId = r.data.id;
      else {
        const ins = await sb.from('forum_topics').insert({title:topicHeader.innerText,slug:currentSlug}).select().maybeSingle();
        if(ins && ins.data && ins.data.id) currentTopicId = ins.data.id;
      }
    }
    if(!currentTopicId){alert('Unable to post: topic not found');sendBtn.disabled=false;sendBtn.innerText='Send';return}
    const payload = {topic_id:currentTopicId,username:auth.username,content:txt,avatar_url:auth.avatarUrl||'img/user.png'};
    const ins = await sb.from('forum_posts').insert(payload);
    if(ins.error){alert('Unable to post');sendBtn.disabled=false;sendBtn.innerText='Send';return}
    msgInput.value = '';
    await selectTopic(currentSlug,topicHeader.innerText);
  }catch(e){
    alert('Error creating post');
  }finally{
    sendBtn.disabled = false;
    sendBtn.innerText = 'Send';
  }
});
loadTopics();
</script>
</body>
</html>