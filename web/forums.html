<!doctype html>
<html lang="ru" class="h-100">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forums - OLDRBX</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="img/ic.png">
<style>
:root{--bg:#0f1112;--panel:#141617;--muted:#9aa0a6;--border:#232526;--accent:#3aa0ff;--card:#161819;--radius:10px}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
.topbar{height:64px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:14px}
.hamburger{width:42px;height:42px;border-radius:8px;background:transparent;border:none;color:var(--muted);font-size:20px;display:none}
.logo-img{height:32px}
.top-right{margin-left:auto;display:flex;gap:12px;align-items:center}
.money-wrap{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:700}
.money-wrap img{width:20px;height:20px}
.balance{font-weight:800;color:#fff}
.avatar{width:40px;height:40px;border-radius:8px;overflow:hidden;background:#fff;display:inline-block}
.avatar img{width:100%;height:100%;object-fit:cover}
.container-layout{display:grid;grid-template-columns:320px 1fr;gap:20px;padding:20px;max-width:1200px;margin:18px auto}
.sidebar{background:linear-gradient(180deg,var(--panel),#121314);border:1px solid var(--border);border-radius:var(--radius);padding:14px;height:calc(100vh - 136px);overflow:auto}
.side-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.side-header .mini{width:48px;height:48px;border-radius:8px;overflow:hidden}
.side-header .mini img{width:100%;height:100%;object-fit:cover}
.username{font-weight:900}
.nav-item{padding:10px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--muted);font-weight:700;margin-bottom:10px;cursor:pointer}
.nav-item:hover{background:rgba(255,255,255,0.02);border-color:var(--border)}
.topics-list{display:flex;flex-direction:column;gap:8px}
.topic-pill{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:transparent;border:1px solid transparent;cursor:pointer}
.topic-pill:hover{background:rgba(255,255,255,0.02);border-color:var(--border)}
.topic-pill.active{background:linear-gradient(90deg,rgba(58,160,255,0.08),transparent);border-left:3px solid var(--accent)}
.topic-title{font-weight:800}
.topic-muted{font-size:12px;color:var(--muted)}
.mainpanel{background:linear-gradient(180deg,var(--card),#0e0f10);border:1px solid var(--border);border-radius:var(--radius);padding:16px;min-height:420px;display:flex;flex-direction:column}
.topic-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.topic-header .title{font-weight:900;font-size:18px}
.topic-sub{font-size:13px;color:var(--muted)}
.posts{flex:1;overflow:auto;padding-right:6px;display:flex;flex-direction:column;gap:12px}
.post{display:flex;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.02);align-items:flex-start}
.post .avatar{width:56px;height:56px;border-radius:12px;overflow:hidden;background:var(--border);flex-shrink:0}
.post .avatar img{width:100%;height:100%;object-fit:cover}
.post .body{flex:1}
.post .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
.post .content{white-space:pre-wrap;color:#e6eef8}
.composer{margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px;display:flex;flex-direction:column;gap:8px}
.composer-row{display:flex;gap:12px;align-items:flex-start}
.composer textarea{flex:1;min-height:96px;background:transparent;border:1px solid var(--border);color:#fff;padding:12px;border-radius:8px;resize:vertical}
.composer .actions{display:flex;justify-content:flex-end;gap:8px}
.btn-primary{background:var(--accent);border-color:var(--accent)}
.empty{color:var(--muted);padding:18px;text-align:center}
.footer{background:transparent;border-top:1px solid var(--border);padding:10px;text-align:center;color:var(--muted);margin-top:12px;border-radius:0}
.small-muted{font-size:13px;color:var(--muted)}
@media(max-width:920px){.container-layout{grid-template-columns:1fr;padding:12px}.sidebar{height:auto;order:2}.hamburger{display:inline-flex}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger" aria-label="menu">&#9776;</button>
  <img src="img/logo.png" class="logo-img" alt="logo">
  <div class="top-right">
    <div class="money-wrap" title="Balance">
      <img id="moneyIcon" src="img/money.png" alt="money">
      <div id="balanceText" class="balance">0</div>
    </div>
    <a id="topAvatar" class="avatar" href="/web/home.html"><img id="topAv" src="img/user.png" alt="avatar"></a>
  </div>
</div>
<div class="container-layout">
  <aside class="sidebar" id="sidebar">
    <div class="side-header">
      <div class="mini"><img id="sideAv" src="img/user.png" alt=""></div>
      <div>
        <div id="sideName" class="username">User</div>
        <div class="small-muted" id="sideSub">Member</div>
      </div>
    </div>
    <div style="margin:10px 0;font-weight:800;color:var(--muted)">Navigation</div>
    <div class="nav-item" data-h="/web/home.html">Home</div>
    <div class="nav-item" data-h="/web/friends.html">Friends</div>
    <div class="nav-item" data-h="/web/groups.html">Groups</div>
    <div class="nav-item" data-h="/web/forums.html">Forums</div>
    <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
    <div style="font-weight:800;margin-bottom:8px;color:var(--muted)">Topics</div>
    <div id="topicsList" class="topics-list"></div>
  </aside>
  <main class="mainpanel">
    <div class="topic-header">
      <div>
        <div id="topicHeader" class="title">Forums</div>
        <div id="topicSub" class="topic-sub">Select a topic to view posts</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="newTopicBtn" class="btn btn-sm btn-outline-light">New Topic</button>
      </div>
    </div>
    <div id="postsList" class="posts">
      <div class="empty">Choose a topic to view posts.</div>
    </div>
    <div id="composerWrap" class="composer" style="display:none">
      <div style="display:flex;align-items:center;gap:10px">
        <img id="meAv" src="img/user.png" style="width:44px;height:44px;border-radius:10px" alt="me">
        <div style="font-weight:800" id="meName">You</div>
      </div>
      <div class="composer-row">
        <textarea id="msgInput" placeholder="Write your message..."></textarea>
      </div>
      <div class="actions composer-row" style="justify-content:flex-end">
        <div style="margin-right:auto" class="small-muted" id="composerNotice"></div>
        <div class="composer-actions">
          <button id="sendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>
  </main>
</div>
<footer class="footer">&copy; 2026 OLDRBX</footer>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPA_URL="https://nkvvnnjukqtfhmegyzek.supabase.co";
const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3F0ZmhtZWd5emVrIiwicm9sZSI6ImFscyIsImlhdCI6MTc2ODY2NDkxMiwiZXhwIjoyMDg0MjQwOTEyfQ.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
let auth=null;
try{auth=JSON.parse(localStorage.getItem('auth')||'{}')}catch(e){auth={}}
if(!auth.username){location.replace('login.html')}
const topicsListEl=document.getElementById('topicsList');
const postsListEl=document.getElementById('postsList');
const topicHeaderEl=document.getElementById('topicHeader');
const topicSubEl=document.getElementById('topicSub');
const composerWrap=document.getElementById('composerWrap');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const meNameEl=document.getElementById('meName');
const meAvEl=document.getElementById('meAv');
const sideAvEl=document.getElementById('sideAv');
const sideNameEl=document.getElementById('sideName');
const balanceTextEl=document.getElementById('balanceText');
const topAvEl=document.getElementById('topAv');
meNameEl.innerText=auth.username;
meAvEl.src=auth.avatarUrl||'img/user.png';
sideAvEl.src=auth.avatarUrl||'img/user.png';
sideNameEl.innerText=auth.username;
topAvEl.src=auth.avatarUrl||'img/user.png';
balanceTextEl.innerText=String(auth.balance??0);
document.getElementById('hamb').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('open'));
document.querySelectorAll('.nav-item').forEach(it=>it.addEventListener('click',()=>location.href=it.dataset.h||it.getAttribute('data-h')));
let currentTopic=null;
function safeText(t){return t==null?'':String(t)}
function createTopicElement(topic,active=false){const el=document.createElement('div');el.className='topic-pill'+(active?' active':'');el.dataset.slug=topic.slug||(topic.title||'topic').toLowerCase().replace(/\s+/g,'-');el.dataset.id=topic.id||'';el.innerHTML=`<div><div class="topic-title">${topic.title||'Untitled'}</div><div class="topic-muted">${topic.description||''}</div></div><div class="topic-muted">${topic.post_count??''}</div>`;el.addEventListener('click',()=>selectTopic(el.dataset.slug,topic.title));return el}
async function loadTopics(){topicsListEl.innerHTML='<div class="small-muted">Loading topics...</div>';try{const {data,error}=await sb.from('forum_topics').select('id,title,slug,description').order('id',{ascending:true});const topics=(data&&data.length)?data:null;if(!topics){populateDefaultTopics();return}topicsListEl.innerHTML='';topics.forEach((t,idx)=>{const el=createTopicElement(t,idx===0);topicsListEl.appendChild(el);if(idx===0)selectTopic(t.slug||el.dataset.slug,t.title)})}catch(e){populateDefaultTopics()}}
function populateDefaultTopics(){const defaults=[{title:'News',slug:'news',description:'Latest announcements'},{title:'Updates',slug:'updates',description:'Product updates & changelog'},{title:"General",slug:'general',description:'General discussion'}];topicsListEl.innerHTML='';defaults.forEach((t,idx)=>{const el=createTopicElement(t,idx===0);topicsListEl.appendChild(el);if(idx===0)selectTopic(t.slug,t.title)})}
async function selectTopic(slug,titleText){if(!slug)return;document.querySelectorAll('.topic-pill').forEach(e=>e.classList.remove('active'));const clicked=[...document.querySelectorAll('.topic-pill')].find(x=>x.dataset.slug===slug);if(clicked)clicked.classList.add('active');topicHeaderEl.innerText=titleText||slug;topicSubEl.innerText='Loading posts...';composerWrap.style.display='none';postsListEl.innerHTML='<div class="small-muted">Loading posts...</div>';try{const res=await sb.from('forum_topics').select('id,title,slug').eq('slug',slug).limit(1).maybeSingle();let topicId=null;if(res&&res.data&&res.data.id){topicId=res.data.id;currentTopic={id:topicId,title:res.data.title||titleText,slug:res.data.slug}}else{const ins=await sb.from('forum_topics').insert({title:titleText||slug,slug:slug}).select().maybeSingle();if(ins&&ins.data&&ins.data.id){topicId=ins.data.id;currentTopic={id:topicId,title:ins.data.title||titleText,slug:ins.data.slug}}}if(!topicId){postsListEl.innerHTML='<div class="empty">Unable to load this topic.</div>';topicSubEl.innerText='';return}const p=await sb.from('forum_posts').select('id,username,content,avatar_url,created_at').eq('topic_id',topicId).order('created_at',{ascending:true});const posts=p.data&&p.data.length?p.data:[];renderPosts(posts);topicSubEl.innerText=`${posts.length} post${posts.length===1?'':'s'}`;composerWrap.style.display='block'}catch(e){postsListEl.innerHTML='<div class="empty">Error loading posts.</div>';topicSubEl.innerText=''}}
function renderPosts(posts){postsListEl.innerHTML='';if(!posts||!posts.length){postsListEl.innerHTML='<div class="empty">No posts yet. Be the first to post.</div>';return}posts.forEach(p=>{const d=document.createElement('div');d.className='post';const av=document.createElement('div');av.className='avatar';const img=document.createElement('img');img.src=p.avatar_url||'img/user.png';av.appendChild(img);const body=document.createElement('div');body.className='body';const meta=document.createElement('div');meta.className='meta';const date=p.created_at?new Date(p.created_at).toLocaleString():'';meta.innerText=`${p.username||'Anonymous'} â€¢ ${date}`;const content=document.createElement('div');content.className='content';content.innerText=safeText(p.content);body.appendChild(meta);body.appendChild(content);d.appendChild(av);d.appendChild(body);postsListEl.appendChild(d)});postsListEl.scrollTop=postsListEl.scrollHeight}
sendBtn.addEventListener('click',async()=>{const txt=msgInput.value.trim();if(!txt)return;if(!currentTopic||!currentTopic.id)return;sendBtn.disabled=true;sendBtn.innerText='Sending...';const payload={topic_id:currentTopic.id,username:auth.username,content:txt,avatar_url:auth.avatarUrl||'img/user.png'};try{const ins=await sb.from('forum_posts').insert(payload).select().maybeSingle();if(ins.error){alert('Unable to post.')}else{await selectTopic(currentTopic.slug,currentTopic.title);msgInput.value=''}}catch(e){alert('Error creating post.')}finally{sendBtn.disabled=false;sendBtn.innerText='Send'}})
document.getElementById('newTopicBtn').addEventListener('click',async()=>{const title=prompt('New topic title:');if(!title)return;const slug=title.toLowerCase().replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-');try{const ins=await sb.from('forum_topics').insert({title,slug}).select().maybeSingle();if(ins.error){alert('Unable to create topic.');return}const topic=ins.data;const el=createTopicElement(topic);topicsListEl.appendChild(el);selectTopic(topic.slug,topic.title)}catch(e){alert('Error creating topic.')}})
loadTopics();
</script>
</body>
</html>