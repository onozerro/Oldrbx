<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forums - OLDRBX</title>
<link rel="icon" href="/img/ic.png">
<style>
:root{--bg:#efefef;--panel:#ffffff;--muted:#666;--border:#d7d7d7;--accent:#111;--shadow:rgba(0,0,0,0.06)}
html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111}
.topbar{height:56px;background:var(--accent);display:flex;align-items:center;padding:0 12px;gap:12px;box-sizing:border-box}
.hamburger{width:44px;height:44px;border-radius:6px;border:none;background:transparent;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.logo-img{height:32px}
.top-right{margin-left:auto;display:flex;align-items:center;gap:12px}
.money-wrap{display:flex;align-items:center;gap:8px;color:#fff;font-weight:800}
.money-wrap img{width:20px;height:20px}
.balance{font-weight:800;color:#fff}
.avatar{width:36px;height:36px;border-radius:6px;overflow:hidden;background:#fff;display:inline-block}
.avatar img{width:100%;height:100%;object-fit:cover}
.container-wrap{max-width:1100px;margin:20px auto;padding:0 16px;box-sizing:border-box}
.layout{display:grid;grid-template-columns:300px 1fr;gap:18px;align-items:start}
.sidebar{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:6px;min-height:320px}
.user-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.user-header .mini{width:44px;height:44px;border-radius:6px;overflow:hidden}
.user-header .mini img{width:100%;height:100%;object-fit:cover}
.username{font-weight:900}
.nav-item{padding:12px;border-radius:6px;background:#fff;border:1px solid var(--border);font-weight:800;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
.main{background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:6px;display:flex;flex-direction:column;gap:16px;min-height:420px}
.section-title{font-weight:900}
.forum-list{display:flex;flex-direction:column;gap:10px}
.forum-item{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.forum-meta{display:flex;flex-direction:column}
.forum-title{font-weight:900}
.forum-desc{font-size:13px;color:var(--muted)}
.forum-controls{display:flex;gap:8px;align-items:center}
.panel-box{background:#fff;border:1px solid var(--border);border-radius:6px;padding:12px;display:flex;flex-direction:column;gap:10px}
.panel-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.back-btn{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800}
.posts-box{max-height:360px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px;border-top:1px solid var(--border)}
.post{display:flex;gap:10px;padding:10px;border-radius:6px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent)}
.post .av{width:44px;height:44px;border-radius:6px;overflow:hidden;background:#efefef;flex-shrink:0}
.post .av img{width:100%;height:100%;object-fit:cover}
.post .body{display:flex;flex-direction:column}
.post .meta{font-weight:800;font-size:13px}
.post .time{font-size:12px;color:var(--muted)}
.composer{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
.composer textarea{flex:1;min-height:72px;border:1px solid var(--border);padding:8px;border-radius:6px;resize:vertical}
.btn{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#fff;font-weight:800;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff;border:none}
.empty{color:var(--muted);padding:12px;text-align:center}
.footer{margin-top:18px;background:var(--panel);border-top:1px solid var(--border);padding:10px 16px;color:var(--muted);font-weight:700;text-align:center;border-radius:0}
@media(max-width:1000px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;left:-360px;top:56px;height:calc(100% - 56px);width:280px;z-index:1200;transition:left .18s ease}.sidebar.open{left:0}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger" aria-label="menu">&#9776;</button>
  <img src="/img/logo.png" class="logo-img" alt="logo">
  <div class="top-right">
    <div class="money-wrap" title="Balance">
      <img id="moneyIcon" src="/img/money.png" alt="money">
      <div id="balanceText" class="balance">0</div>
    </div>
    <a id="profileBtnTop" class="avatar" href="/web/home.html"><img id="topAv" src="/img/user.png" alt="avatar"></a>
  </div>
</div>
<div class="container-wrap">
  <div class="layout">
    <aside id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="user-header">
        <div class="mini"><img id="sideAv" src="/img/user.png" alt=""></div>
        <div><div id="sideName" class="username">User</div></div>
      </div>
      <div id="navHome" class="nav-item" data-h="/web/home.html">Home</div>
      <div id="navFriends" class="nav-item" data-h="/web/friends.html">Friends</div>
      <div id="navGroups" class="nav-item" data-h="/web/groups.html">Groups</div>
      <div id="navForums" class="nav-item" data-h="/web/forums.html">Forums</div>
      <div id="navUsers" class="nav-item" data-h="/web/users.html">Users</div>
    </aside>
    <main class="main" role="main">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="section-title">Forums</div>
        <div class="forum-controls"></div>
      </div>
      <div id="centerContent" class="forum-list panel-box">
        <div id="forumsContainer"></div>
      </div>
    </main>
  </div>
  <div class="footer">© 2026 OLDRBX</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded',async function(){
  const SUPA_URL="https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3R0ZmhtZWd5emVrIiwicm9sZSI6ImFscyIsImlhdCI6MTc2ODY2NDkxMiwiZXhwIjoyMDg0MjQwOTEyfQ.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
  var hamb=document.getElementById('hamb'),sidebar=document.getElementById('sidebar');
  hamb.addEventListener('click',function(){if(window.innerWidth<1000)sidebar.classList.toggle('open')});
  function nav(h){location.href=h}
  document.querySelectorAll('.nav-item').forEach(function(it){it.addEventListener('click',function(){nav(it.dataset.h)})});
  var auth=null;try{auth=JSON.parse(localStorage.getItem('auth'))}catch(e){auth=null}
  if(!auth||!auth.username){location.replace('/web/login.html');return}
  document.getElementById('sideName').innerText=auth.username;
  document.getElementById('profileBtnTop').href='/web/home.html';
  function setAv(u){var x=u||'/img/user.png';document.getElementById('sideAv').src=x;document.getElementById('topAv').src=x}
  setAv(auth.avatarUrl||'/img/user.png');
  document.getElementById('moneyIcon').src='/img/money.png';
  var localBal=(typeof auth.balance!=='undefined'&&auth.balance!==null)?auth.balance:0;
  document.getElementById('balanceText').innerText=String(localBal);
  async function getUserByUsername(u){var r=await sb.from('users').select('*').eq('username',u).maybeSingle();if(r.error) return null;return r.data||null}
  var userRow=await getUserByUsername(auth.username);
  if(userRow&&typeof userRow.balance!=='undefined')document.getElementById('balanceText').innerText=String(userRow.balance);
  if(userRow&&userRow.avatar_url)setAv(userRow.avatar_url);
  if(userRow&&userRow.id)await sb.from('users').update({last_active:new Date().toISOString()}).eq('id',userRow.id);
  var centerContent=document.getElementById('centerContent');
  var forumsContainer=document.getElementById('forumsContainer');
  async function loadForums(){
    forumsContainer.innerHTML='<div class="empty">Loading forums...</div>';
    try{
      var res=await sb.from('forum_topics').select('id,title,slug,description').order('id',{ascending:true});
      if(res.error||!res.data||!res.data.length){
        var defaults=[{title:'News',slug:'news',description:'Latest announcements'},{title:'Updates',slug:'updates',description:'Product updates'},{title:'General',slug:'general',description:'General discussion'}];
        renderForumList(defaults);
        return;
      }
      renderForumList(res.data);
    }catch(e){
      forumsContainer.innerHTML='<div class="empty">Unable to load forums</div>';
    }
  }
  function renderForumList(list){
    forumsContainer.innerHTML='';
    list.forEach(function(f){
      var item=document.createElement('div');item.className='forum-item';
      var meta=document.createElement('div');meta.className='forum-meta';
      var title=document.createElement('div');title.className='forum-title';title.innerText=f.title||'Untitled';
      var desc=document.createElement('div');desc.className='forum-desc';desc.innerText=f.description||'';
      meta.appendChild(title);meta.appendChild(desc);
      item.appendChild(meta);
      item.addEventListener('click',function(){openForum(f)});
      forumsContainer.appendChild(item);
    });
  }
  function createPanelHeader(title){
    var header=document.createElement('div');header.className='panel-header';
    var left=document.createElement('div');left.style.display='flex';left.style.alignItems='center';left.style.gap='10px';
    var back=document.createElement('button');back.className='back-btn';back.innerText='← Back';back.addEventListener('click',backToList);
    var ttl=document.createElement('div');ttl.style.fontWeight='900';ttl.innerText=title||'Forum';
    left.appendChild(back);left.appendChild(ttl);
    var right=document.createElement('div');
    header.appendChild(left);header.appendChild(right);
    return {header,back};
  }
  async function openForum(f){
    centerContent.scrollTop=0;
    forumsContainer.innerHTML='';
    var id=f.id||null;
    try{
      var res=await sb.from('forum_topics').select('id,title,slug,description').eq('slug',f.slug).limit(1).maybeSingle();
      if(res && res.data && res.data.id) id=res.data.id;
      else if(!id){
        var ins=await sb.from('forum_topics').insert({title:f.title,slug:f.slug,description:f.description}).select().maybeSingle();
        if(ins && ins.data && ins.data.id) id=ins.data.id;
      }
    }catch(e){
      console.error(e);
    }
    var ph=createPanelHeader(f.title);
    var panel=document.createElement('div');panel.className='panel-box';
    panel.appendChild(ph.header);
    var postsBox=document.createElement('div');postsBox.className='posts-box';
    postsBox.innerHTML='<div class="empty">Loading messages...</div>';
    panel.appendChild(postsBox);
    var composer=document.createElement('div');composer.className='composer';
    var av=document.createElement('div');av.className='av';av.style.width='44px';av.style.height='44px';
    var avimg=document.createElement('img');avimg.src=auth.avatarUrl||'/img/user.png';avimg.style.width='100%';avimg.style.height='100%';avimg.style.objectFit='cover';
    av.appendChild(avimg);
    var textarea=document.createElement('textarea');textarea.placeholder='Write your message...';
    var send=document.createElement('button');send.className='btn btn-primary';send.innerText='Send';
    composer.appendChild(av);composer.appendChild(textarea);composer.appendChild(send);
    panel.appendChild(composer);
    forumsContainer.appendChild(panel);
    ph.back.addEventListener('click',backToList);
    send.addEventListener('click',async function(){
      var txt=textarea.value.trim();
      if(!txt) return;
      send.disabled=true;send.innerText='Sending...';
      var payload={topic_id:id,username:auth.username,content:txt,avatar_url:auth.avatarUrl||'/img/user.png'};
      try{
        var ins=await sb.from('forum_posts').insert(payload).select().maybeSingle();
        if(ins && ins.error){console.error(ins.error);alert('Unable to post');}
        else await loadPostsInto(postsBox,id);
      }catch(e){console.error(e);alert('Error posting');}
      send.disabled=false;send.innerText='Send';
    });
    if(id) await loadPostsInto(postsBox,id);
    else postsBox.innerHTML='<div class="empty">Unable to load messages for this forum</div>';
  }
  async function loadPostsInto(container,topicId){
    container.innerHTML='<div class="empty">Loading messages...</div>';
    try{
      var p=await sb.from('forum_posts').select('id,username,content,avatar_url,created_at,topic_id').eq('topic_id',topicId).order('created_at',{ascending:false});
      if(p.error){console.error(p.error);container.innerHTML='<div class="empty">Error loading messages</div>';return}
      var rows=p.data&&p.data.length?p.data:[];
      container.innerHTML='';
      if(!rows.length){container.innerHTML='<div class="empty">No messages yet</div>';return}
      rows.forEach(function(r){
        var el=document.createElement('div');el.className='post';
        var av=document.createElement('div');av.className='av';var i=document.createElement('img');i.src=r.avatar_url||'/img/user.png';i.style.width='100%';i.style.height='100%';i.style.objectFit='cover';av.appendChild(i);
        var body=document.createElement('div');body.className='body';
        var meta=document.createElement('div');meta.className='meta';meta.innerText=(r.username||'Anonymous');
        var time=document.createElement('div');time.className='time';time.innerText=r.created_at?new Date(r.created_at).toLocaleString():'';
        var content=document.createElement('div');content.style.marginTop='6px';content.innerText=r.content||'';
        body.appendChild(meta);body.appendChild(time);body.appendChild(content);
        el.appendChild(av);el.appendChild(body);
        container.appendChild(el);
      });
    }catch(e){
      console.error(e);
      container.innerHTML='<div class="empty">Error loading messages</div>';
    }
  }
  function backToList(){loadForums()}
  await loadForums();
  window.addEventListener('resize',function(){if(window.innerWidth>=1000)sidebar.classList.remove('open')});
});
</script>
</body>
</html>