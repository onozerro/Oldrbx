<!doctype html>
<html lang="en" class="h-100">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forums - OLDRBX</title>
<link rel="icon" type="image/png" href="img/ic.png">
<style>
:root{
  --blue:#0074bd;
  --bg:#e9e9ea;
  --panel:#ffffff;
  --muted:#6f6f6f;
  --border:#d5d7d9;
  --accent:#0074bd;
  --shadow:rgba(0,0,0,0.06);
}
html,body{height:100%;margin:0;background:var(--bg);color:#111;font-family:Arial,Helvetica,sans-serif}
.topbar{height:56px;background:var(--blue);display:flex;align-items:center;padding:0 12px;gap:12px;box-sizing:border-box}
.hamburger{width:44px;height:44px;border-radius:6px;background:transparent;border:none;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.logo-img{height:34px}
.top-right{margin-left:auto;display:flex;align-items:center;gap:12px;padding-right:6px}
.money-wrap{display:flex;align-items:center;gap:8px;color:#fff;font-weight:800}
.money-wrap img{width:22px;height:22px;display:block}
.balance{color:#fff;font-weight:800;line-height:1}
.avatar{width:36px;height:36px;border-radius:50%;overflow:hidden;background:#fff;display:inline-block}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.page{max-width:980px;margin:28px auto;padding:0 16px;box-sizing:border-box}
.header-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.header-title{font-weight:800;font-size:18px}
.container-layout{display:grid;grid-template-columns:280px 1fr;gap:18px}
.sidebar{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:12px;box-sizing:border-box}
.nav-item{padding:12px;border-radius:6px;display:flex;align-items:center;justify-content:space-between;font-weight:800;color:#111;text-decoration:none;cursor:pointer;background:#fff;border:1px solid var(--border);box-shadow:0 6px 14px var(--shadow);margin-bottom:8px}
.topics-panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:12px;box-sizing:border-box}
.topics-grid{display:flex;flex-direction:column;gap:10px}
.topic-btn{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#fff;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-weight:800;box-shadow:0 6px 14px var(--shadow);gap:12px}
.topic-btn .left{display:flex;flex-direction:column;gap:4px;align-items:flex-start}
.topic-btn .title{font-weight:800}
.topic-btn .meta{font-size:12px;color:var(--muted);font-weight:700}
.topic-btn .right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.count-pill{background:#f3f5f6;border:1px solid var(--border);padding:6px 10px;border-radius:6px;font-weight:800;font-size:13px}
.mainpanel{background:transparent;border-radius:0;padding:14px;min-height:420px;display:flex;flex-direction:column}
.back-btn{display:none;margin-bottom:12px;color:var(--accent);font-weight:800;cursor:pointer}
.posts{flex:1;overflow:auto;padding-right:6px;display:flex;flex-direction:column-reverse}
.post{display:flex;gap:12px;padding:12px;border-radius:6px;border-bottom:1px solid var(--border);align-items:flex-start;background:#fff}
.post .avatar{width:52px;height:52px;border-radius:50%;overflow:hidden;background:var(--border);flex:0 0 52px}
.post .avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.post .body{flex:1}
.post .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
.composer{margin-top:12px;display:flex;gap:10px;align-items:flex-start}
.composer textarea{flex:1;min-height:90px;background:#fafafa;border:1px solid var(--border);color:#111;padding:10px;border-radius:6px;resize:vertical}
.composer button{height:40px;border-radius:6px;background:#111;color:#fff;border:none;padding:8px 14px;cursor:pointer;font-weight:800;box-shadow:none}
.site-footer{width:100%;background:var(--panel);border-top:1px solid var(--border);padding:10px 18px;color:var(--muted);box-sizing:border-box;margin-top:18px;border-radius:0}
@media(max-width:1000px){
  .container-layout{grid-template-columns:1fr;padding:12px}
  .sidebar{position:fixed;left:-360px;top:56px;height:calc(100% - 56px);z-index:1050;transition:left .18s ease}
  .sidebar.open{left:0}
}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger">&#9776;</button>
  <img src="img/logo.png" class="logo-img">
  <div class="top-right">
    <div class="money-wrap" title="Balance">
      <img id="moneyIcon" src="img/money.png">
      <div class="balance" id="balanceText">0</div>
    </div>
    <a id="profileLink" href="profile-paid.html" class="avatar"><img id="topAv" src="img/user.png"></a>
  </div>
</div>

<div class="page">
  <div class="container-layout">
    <aside class="sidebar" id="leftSidebar">
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="nav-item" onclick="location.href='home-paid.html'">Home</div>
        <div class="nav-item" onclick="location.href='forums-paid.html'">Forums</div>
        <div class="nav-item locked" id="navProfile">Profile</div>
      </div>
    </aside>

    <main class="mainpanel">
      <div id="topicsPanel" class="topics-panel">
        <div id="topicsList" class="topics-grid"></div>
      </div>

      <div class="posts" id="postsList"></div>

      <div id="composerWrap" style="margin-top:12px;display:none">
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Post as <span id="meName"></span></div>
        <div class="composer">
          <img id="meAv" src="img/user.png">
          <textarea id="msgInput" placeholder="Write your message..."></textarea>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="site-footer">© 2026 OLDRBX</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', async function(){
  const SUPA_URL="https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3F0ZmhtZWd5emVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQ5MTIsImV4cCI6MjA4NDI0MDkxMn0.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
  let currentTopicId=null;
  let auth=null;
  try{auth=JSON.parse(localStorage.getItem('auth'))}catch(e){auth=null}
  if(!auth||!auth.username){location.replace('login.html');return}
  document.getElementById('meName').innerText=auth.username;
  document.getElementById('meAv').src=auth.avatarUrl||'img/user.png';
  document.getElementById('topAv').src=auth.avatarUrl||'img/user.png';
  document.getElementById('balanceText').innerText=auth.balance||0;
  document.getElementById('moneyIcon').src='img/money.png';
  document.getElementById('hamb').addEventListener('click',()=>document.getElementById('leftSidebar').classList.toggle('open'));

  async function ensureTopics(){
    const {data,error}=await sb.from('forum_topics').select('*').order('id',{ascending:true});
    return data||[];
  }

  async function createDefaultTopicsIfMissing(){
    const t=await ensureTopics();
    if(!t.length){
      const defaults=[
        {slug:'news',title:'News'},
        {slug:'updates',title:'Updates'},
        {slug:'general',title:"What's on your mind"}
      ];
      for(const d of defaults) await sb.from('forum_topics').insert(d).select().maybeSingle();
    }
  }

  async function loadTopicsToUI(){
    await createDefaultTopicsIfMissing();
    const {data}=await sb.from('forum_topics').select('*').order('id',{ascending:true});
    const container=document.getElementById('topicsList');
    container.innerHTML='';
    for(const t of data){
      const lastQ=await sb.from('forum_posts').select('created_at,username').eq('topic_id',t.id).order('created_at',{ascending:false}).limit(1).maybeSingle();
      const cntResp=await sb.from('forum_posts').select('id',{count:'exact',head:true}).eq('topic_id',t.id);
      const count=cntResp.count||0;
      const lastAt=lastQ&&lastQ.data?new Date(lastQ.data.created_at):null;
      const lastText=lastAt?timeAgo(lastAt):'—';
      const el=document.createElement('div');
      el.className='topic-btn';
      el.dataset.id=t.id;
      el.innerHTML='<div class="left"><div class="title">'+escapeHtml(t.title)+'</div><div class="meta">'+(lastQ&&lastQ.data&&lastQ.data.username?escapeHtml(lastQ.data.username)+' • '+lastText:'No messages yet')+'</div></div><div class="right"><div class="count-pill">'+count+'</div><div style="font-size:12px;color:var(--muted)">'+lastText+'</div></div>';
      el.addEventListener('click',()=>selectTopic(t.id,t.title));
      container.appendChild(el);
    }
  }

  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return s+'s';const m=Math.floor(s/60);if(m<60)return m+'m';const h=Math.floor(m/60);if(h<24)return h+'h';const day=Math.floor(h/24);if(day<7)return day+'d';return d.toLocaleDateString();}

  async function selectTopic(id,title){
    currentTopicId=id;
    const elems=document.querySelectorAll('.topic-btn');
    elems.forEach(e=>e.classList.remove('active'));
    const clicked=[...elems].find(x=>Number(x.dataset.id)===Number(id));
    if(clicked) clicked.classList.add('active');
    document.getElementById('composerWrap').style.display='block';
    await loadPosts(id);
  }

  async function loadPosts(topicId){
    const {data:posts}=await sb.from('forum_posts').select('*').eq('topic_id',topicId).order('created_at',{ascending:true});
    const list=document.getElementById('postsList');
    list.innerHTML='';
    for(const p of posts){
      const d=document.createElement('div');
      d.className='post';
      const av=document.createElement('div');av.className='avatar';
      const img=document.createElement('img');
      img.src=p.avatar_url||auth.avatarUrl||'img/user.png';
      av.appendChild(img);
      const body=document.createElement('div');body.className='body';
      const meta=document.createElement('div');meta.className='meta';
      meta.innerText=(p.username||'Unknown')+' • '+(p.created_at?new Date(p.created_at).toLocaleString():'');
      const msg=document.createElement('div');msg.innerText=p.content||'';
      body.appendChild(meta);body.appendChild(msg);
      d.appendChild(av);d.appendChild(body);
      list.appendChild(d);
    }
  }

  document.getElementById('sendBtn').addEventListener('click',async function(){
    const txt=document.getElementById('msgInput').value.trim();
    if(!txt||!currentTopicId) return;
    const payload={topic_id:currentTopicId,username:auth.username,content:txt,avatar_url:auth.avatarUrl||'user.png'};
    await sb.from('forum_posts').insert(payload).select().maybeSingle();
    document.getElementById('msgInput').value='';
    await loadPosts(currentTopicId);
    await loadTopicsToUI();
  });

  await loadTopicsToUI();
});
</script>
</body>
</html>