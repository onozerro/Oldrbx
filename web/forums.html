<!doctype html>
<html lang="en" class="h-100">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forums - OLDRBX</title>
<link rel="icon" type="image/png" href="img/ic.png">
<style>
:root{--bg:#efefef;--panel:#ffffff;--muted:#666;--border:#d7d7d7;--accent:#111;--shadow:rgba(0,0,0,0.06)}
html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111}
.topbar{height:56px;background:var(--accent);display:flex;align-items:center;padding:0 12px;gap:12px;box-sizing:border-box}
.hamburger{width:44px;height:44px;border-radius:6px;border:none;background:transparent;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.logo-img{height:32px}
.top-right{margin-left:auto;display:flex;align-items:center;gap:12px}
.money-wrap{display:flex;align-items:center;gap:8px;color:#fff;font-weight:800}
.money-wrap img{width:20px;height:20px}
.balance{font-weight:800;color:#fff}
.avatar{width:36px;height:36px;border-radius:6px;overflow:hidden;background:#fff;display:inline-block}
.avatar img{width:100%;height:100%;object-fit:cover}
.container-wrap{max-width:1100px;margin:20px auto;padding:0 16px;box-sizing:border-box}
.layout{display:grid;grid-template-columns:300px 1fr;gap:18px;align-items:start}
.sidebar{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:6px;min-height:320px}
.user-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.user-header .mini{width:44px;height:44px;border-radius:6px;overflow:hidden}
.user-header .mini img{width:100%;height:100%;object-fit:cover}
.username{font-weight:900}
.nav-item{padding:12px;border-radius:6px;background:#fff;border:1px solid var(--border);font-weight:800;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
.main{background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:6px;display:flex;flex-direction:column;gap:16px;min-height:420px}
.section-title{font-weight:900}
.topics-panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:12px;box-sizing:border-box}
.topics-grid{display:flex;flex-direction:column;gap:10px}
.topic-btn{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#fff;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-weight:800;gap:12px}
.topic-btn .left{display:flex;flex-direction:column;gap:4px;align-items:flex-start}
.topic-btn .title{font-weight:800}
.topic-btn .meta{font-size:12px;color:var(--muted);font-weight:700}
.topic-btn .right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.count-pill{background:#f3f5f6;border:1px solid var(--border);padding:6px 10px;border-radius:6px;font-weight:800;font-size:13px}
.back-btn{display:none;margin-bottom:12px;color:var(--muted);font-weight:800;cursor:pointer}
.topic-header{font-weight:900;margin-bottom:8px}
.posts{flex:1;max-height:360px;overflow:auto;padding-right:6px}
.post{display:flex;gap:12px;padding:12px;border-radius:6px;border-bottom:1px solid var(--border);align-items:flex-start;background:#fff}
.post .avatar{width:52px;height:52px;border-radius:6px;overflow:hidden;background:var(--border);flex:0 0 52px}
.post .avatar img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.post .body{flex:1}
.post .meta{font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:800}
.composer{margin-top:12px;display:flex;gap:10px;align-items:flex-start}
.composer textarea{flex:1;min-height:90px;background:#fafafa;border:1px solid var(--border);color:#111;padding:10px;border-radius:6px;resize:vertical}
.composer button{height:40px;border-radius:6px;background:var(--accent);color:#fff;border:none;padding:8px 14px;cursor:pointer;font-weight:800;box-shadow:0 6px 14px var(--shadow)}
.load-more{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800;margin:8px auto;display:block}
.empty{color:var(--muted);padding:18px;text-align:center}
.footer{margin-top:18px;background:var(--panel);border-top:1px solid var(--border);padding:10px 16px;color:var(--muted);font-weight:700;text-align:center;border-radius:0}
@media(max-width:1000px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;left:-360px;top:56px;height:calc(100% - 56px);width:280px;z-index:1200;transition:left .18s ease}.sidebar.open{left:0}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger" aria-label="menu">&#9776;</button>
  <img src="/img/logo.png" class="logo-img" alt="logo">
  <div class="top-right">
    <div class="money-wrap" title="Balance">
      <img id="moneyIcon" src="/img/money.png" alt="money">
      <div id="balanceText" class="balance">0</div>
    </div>
    <a id="profileBtnTop" class="avatar" href="/web/home.html"><img id="topAv" src="/img/user.png" alt="avatar"></a>
  </div>
</div>

<div class="container-wrap">
  <div class="layout">
    <aside id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="user-header">
        <div class="mini"><img id="sideAv" src="/img/user.png" alt=""></div>
        <div><div id="sideName" class="username">User</div></div>
      </div>
      <div id="navHome" class="nav-item" data-h="/web/home.html">Home</div>
      <div id="navFriends" class="nav-item" data-h="/web/friends.html">Friends</div>
      <div id="navGroups" class="nav-item" data-h="/web/groups.html">Groups</div>
      <div id="navForums" class="nav-item" data-h="/web/forums.html">Forums</div>
      <div id="navUsers" class="nav-item" data-h="/web/users.html">Users</div>
    </aside>

    <main class="main" role="main">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="section-title">Forums</div>
      </div>

      <div id="topicsPanel" class="topics-panel">
        <div id="topicsList" class="topics-grid"></div>
      </div>

      <div id="backBtn" class="back-btn" onclick="backToTopics()">← Back to topics</div>
      <div id="topicHeader" class="topic-header"></div>

      <div class="posts" id="postsList"></div>
      <button id="loadMoreBtn" class="load-more" style="display:none">Load older messages</button>

      <div id="composerWrap" style="margin-top:12px;display:none">
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Post as <span id="meName"></span></div>
        <div class="composer">
          <img id="meAv" src="/img/user.png" style="width:52px;height:52px;border-radius:6px" alt="avatar">
          <textarea id="msgInput" placeholder="Write your message..."></textarea>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </main>
  </div>
  <div class="footer">© 2026 OLDRBX</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', async function(){
  const SUPA_URL = "https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3F0ZmhtZWd5emVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQ5MTIsImV4cCI6MjA4NDI0MDkxMn0.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

  let currentTopicId = null;
  let auth = null;
  try{ auth = JSON.parse(localStorage.getItem('auth')) }catch(e){ auth = null }
  if(!auth || !auth.username){ location.replace('/web/login.html'); return }

  document.getElementById('meName').innerText = auth.username;
  document.getElementById('meAv').src = auth.avatarUrl || '/img/user.png';
  document.getElementById('topAv').src = auth.avatarUrl || '/img/user.png';
  document.getElementById('sideName').innerText = auth.username;
  var bal = (typeof auth.balance !== 'undefined' && auth.balance !== null) ? auth.balance : 0;
  document.getElementById('balanceText').innerText = String(bal);
  document.getElementById('moneyIcon').src = '/img/money.png';
  document.getElementById('hamb').addEventListener('click', function(){ document.getElementById('sidebar').classList.toggle('open') });

  const PAGE_SIZE = 10;
  let oldestCursor = null;
  let moreAvailable = false;

  async function ensureTopics(){
    const { data, error } = await sb.from('forum_topics').select('*').order('id',{ascending:true});
    if(error) return [];
    return data || [];
  }
  async function createDefaultTopicsIfMissing(){
    const t = await ensureTopics();
    if(!t || !t.length){
      const defaults = [
        { slug: 'news', title: 'News' },
        { slug: 'updates', title: 'Updates' },
        { slug: 'general', title: "What's on your mind" }
      ];
      for(const d of defaults){
        await sb.from('forum_topics').insert(d).select().maybeSingle();
      }
    }
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,function(m){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]}) }
  function timeAgo(d){
    const s = Math.floor((Date.now() - d.getTime())/1000);
    if(s < 60) return s + 's';
    const m = Math.floor(s/60);
    if(m < 60) return m + 'm';
    const h = Math.floor(m/60);
    if(h < 24) return h + 'h';
    const day = Math.floor(h/24);
    if(day < 7) return day + 'd';
    return d.toLocaleDateString();
  }

  async function loadTopicsToUI(){
    await createDefaultTopicsIfMissing();
    const { data, error } = await sb.from('forum_topics').select('*').order('id',{ascending:true});
    const container = document.getElementById('topicsList');
    container.innerHTML = '';
    const topics = (data && data.length) ? data : [];
    for(const t of topics){
      let lastQ = null;
      try{ lastQ = await sb.from('forum_posts').select('created_at,username').eq('topic_id',t.id).order('created_at',{ascending:false}).limit(1).maybeSingle(); }catch(e){ lastQ = null }
      let count = 0;
      try{ const cntResp = await sb.from('forum_posts').select('id', { count: 'exact', head: true }).eq('topic_id', t.id); count = typeof cntResp.count === 'number' ? cntResp.count : 0; }catch(e){ count = 0 }
      const lastAt = lastQ && lastQ.data ? new Date(lastQ.data.created_at) : null;
      const lastText = lastAt ? timeAgo(lastAt) : '—';
      const el = document.createElement('div');
      el.className = 'topic-btn';
      el.dataset.id = t.id;
      el.innerHTML = '<div class="left"><div class="title">'+escapeHtml(t.title)+'</div><div class="meta">'+(lastQ && lastQ.data && lastQ.data.username ? escapeHtml(lastQ.data.username) + ' • ' + lastText : 'No messages yet')+'</div></div><div class="right"><div class="count-pill">'+count+'</div><div style="font-size:12px;color:var(--muted)">'+lastText+'</div></div>';
      el.addEventListener('click', function(){ selectTopic(t.id, t.title) });
      container.appendChild(el);
    }
  }

  async function selectTopic(id, title){
    currentTopicId = id;
    document.getElementById('topicHeader').innerText = title || '';
    const elems = document.querySelectorAll('.topic-btn');
    elems.forEach(e => e.classList.remove('active'));
    const clicked = [...elems].find(x => Number(x.dataset.id) === Number(id));
    if(clicked) clicked.classList.add('active');
    document.getElementById('topicsPanel').style.display = 'none';
    document.getElementById('backBtn').style.display = 'block';
    document.getElementById('composerWrap').style.display = 'block';
    oldestCursor = null;
    await loadPostsPage(id, true);
  }

  async function loadPostsPage(topicId, reset){
    const list = document.getElementById('postsList');
    if(reset){
      list.innerHTML = '';
      oldestCursor = null;
      moreAvailable = false;
      document.getElementById('loadMoreBtn').style.display = 'none';
    }
    let query = sb.from('forum_posts').select('id,username,content,avatar_url,created_at').eq('topic_id',topicId).order('created_at',{ascending:false}).limit(PAGE_SIZE);
    if(oldestCursor){
      query = sb.from('forum_posts').select('id,username,content,avatar_url,created_at').lt('created_at', oldestCursor).eq('topic_id',topicId).order('created_at',{ascending:false}).limit(PAGE_SIZE);
    }
    const { data: posts, error } = await query;
    if(error){
      list.innerHTML = '<div class="empty">Error loading messages</div>';
      return;
    }
    if(!posts || !posts.length){
      if(reset) list.innerHTML = '<div class="empty">No messages yet</div>';
      return;
    }
    for(const p of posts){
      const d = document.createElement('div');
      d.className = 'post';
      const av = document.createElement('div'); av.className='avatar';
      const img = document.createElement('img');
      const avatarUrl = p.avatar_url || auth.avatarUrl || 'user.png';
      if(avatarUrl.indexOf('http')===0 || avatarUrl.indexOf('//')===0) img.src = avatarUrl;
      else if(avatarUrl.indexOf('/')===0) img.src = avatarUrl;
      else img.src = '/img/' + avatarUrl;
      av.appendChild(img);
      const body = document.createElement('div'); body.className='body';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerText = (p.username || 'Unknown') + ' • ' + (p.created_at ? new Date(p.created_at).toLocaleString() : '');
      const msg = document.createElement('div'); msg.innerText = p.content || '';
      body.appendChild(meta); body.appendChild(msg);
      d.appendChild(av); d.appendChild(body);
      list.appendChild(d);
    }
    if(posts.length === PAGE_SIZE){
      oldestCursor = posts[posts.length - 1].created_at;
      moreAvailable = true;
      document.getElementById('loadMoreBtn').style.display = 'block';
    } else {
      oldestCursor = posts[posts.length - 1].created_at;
      moreAvailable = false;
      document.getElementById('loadMoreBtn').style.display = 'none';
    }
    if(reset){
      const node = list.firstChild;
      if(node) node.scrollIntoView({behavior:'auto', block:'start'});
    } else {
      list.scrollTop = list.scrollHeight;
    }
  }

  document.getElementById('loadMoreBtn').addEventListener('click', async function(){
    if(!currentTopicId || !moreAvailable) return;
    await loadPostsPage(currentTopicId, false);
  });

  document.getElementById('backBtn').addEventListener('click', function(){
    document.getElementById('topicsPanel').style.display = '';
    document.getElementById('backBtn').style.display = 'none';
    document.getElementById('topicHeader').innerText = '';
    document.getElementById('postsList').innerHTML = '';
    document.getElementById('composerWrap').style.display = 'none';
    currentTopicId = null;
    const elems = document.querySelectorAll('.topic-btn');
    elems.forEach(e => e.classList.remove('active'));
    document.getElementById('loadMoreBtn').style.display = 'none';
  });

  document.getElementById('sendBtn').addEventListener('click', async function(){
    const txt = document.getElementById('msgInput').value.trim();
    if(!txt || !currentTopicId) return;
    const payload = { topic_id: currentTopicId, username: auth.username, content: txt, avatar_url: auth.avatarUrl || 'user.png' };
    this.disabled = true;
    this.innerText = 'Sending...';
    try{
      const { data, error } = await sb.from('forum_posts').insert(payload);
      if(error){
        console.error(error);
        alert('Unable to post: ' + (error.message || 'unknown'));
        return;
      }
      document.getElementById('msgInput').value = '';
      await loadPostsPage(currentTopicId, true);
      await loadTopicsToUI();
    }catch(e){
      console.error(e);
      alert('Error posting message');
    } finally {
      this.disabled = false;
      this.innerText = 'Send';
    }
  });

  await loadTopicsToUI();
});
</script>
</body>
</html>