<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Groups - OLDRBX</title>
<link rel="icon" href="/img/ic.png">
<style>
:root{--bg:#efefef;--panel:#ffffff;--muted:#666;--border:#d7d7d7;--accent:#111}
html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111}
.topbar{height:56px;background:var(--accent);display:flex;align-items:center;padding:0 12px;gap:12px}
.hamburger{width:44px;height:44px;border-radius:4px;border:none;background:transparent;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.logo-img{height:32px}
.container-wrap{max-width:1100px;margin:20px auto;padding:0 16px}
.layout{display:grid;grid-template-columns:300px 1fr;gap:18px}
.sidebar{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:6px}
.nav-item{padding:12px;border-radius:6px;background:#fff;border:1px solid var(--border);font-weight:800;margin-bottom:10px;cursor:pointer}
.main{background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:6px}
.section-title{font-weight:900;margin-bottom:8px}
.group-card{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;background:#fff}
.group-left{display:flex;align-items:center;gap:10px}
.group-left img{width:60px;height:60px;border-radius:6px;object-fit:cover}
.create-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
input[type="text"]{padding:8px;border:1px solid var(--border);border-radius:6px}
textarea{padding:8px;border:1px solid var(--border);border-radius:6px;resize:vertical}
.btn{padding:8px 12px;border-radius:6px;border:none;font-weight:800;cursor:pointer}
.btn-create{background:var(--accent);color:#fff}
.btn-disabled{background:#fff;border:1px solid var(--border);color:#999;cursor:not-allowed}
.empty{color:var(--muted);padding:12px;text-align:center}
.footer{margin-top:18px;background:var(--panel);border-top:1px solid var(--border);padding:10px 16px;color:var(--muted);font-weight:700;border-radius:0;text-align:center}
@media(max-width:1000px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;left:-360px;top:56px;height:calc(100% - 56px);width:280px;z-index:1200;transition:left .18s ease}.sidebar.open{left:0}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger" aria-label="menu">&#9776;</button>
  <img src="/img/logo.png" class="logo-img" alt="logo">
</div>
<div class="container-wrap">
  <div class="layout">
    <aside id="sidebar" class="sidebar">
      <div id="navHome" class="nav-item">Home</div>
      <div id="navFriends" class="nav-item">Friends</div>
      <div id="navGroups" class="nav-item">Groups</div>
      <div id="navForums" class="nav-item">Forums</div>
    </aside>
    <main class="main">
      <div>
        <div class="section-title">Create Group (Cost: 100)</div>
        <div class="create-row">
          <input id="groupName" type="text" placeholder="Group name">
          <button id="createBtn" class="btn btn-create">Create</button>
        </div>
        <div id="createFeedback" class="empty"></div>
      </div>
      <div style="margin-top:14px">
        <div class="section-title">Popular Groups</div>
        <div id="groupsList"></div>
      </div>
    </main>
  </div>
  <div class="footer">Â© 2026 OLDRBX</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded',async function(){
  const SUPA_URL="https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3R0ZmhtZWd5emVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQ5MTIsImV4cCI6MjA4NDI0MDkxMn0.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
  var hamb=document.getElementById('hamb'),sidebar=document.getElementById('sidebar');
  hamb.addEventListener('click',function(){if(window.innerWidth<1000)sidebar.classList.toggle('open')});
  var auth=null;try{auth=JSON.parse(localStorage.getItem('auth'))}catch(e){auth=null}
  if(!auth||!auth.username){location.replace('/web/login.html');return}
  document.getElementById('navHome').addEventListener('click',function(){location.href='/web/home.html'});
  document.getElementById('navFriends').addEventListener('click',function(){location.href='/web/friends.html'});
  document.getElementById('navForums').addEventListener('click',function(){location.href='/web/forums.html'});
  async function getUser(){var r=await sb.from('users').select('*').eq('username',auth.username).maybeSingle();if(r.error) return null;return r.data||null}
  var userRow=await getUser();
  async function refreshGroups(){
    var wrap=document.getElementById('groupsList');wrap.innerHTML='';
    var res=await sb.from('groups').select('id,name,description,image_url,member_count').order('member_count',{ascending:false});
    if(!res.data||!res.data.length){wrap.innerHTML='<div class="empty">No groups yet</div>';return}
    for(var g of res.data){
      var card=document.createElement('div');card.className='group-card';
      var left=document.createElement('div');left.className='group-left';
      var img=document.createElement('img');img.src=g.image_url?g.image_url:'/img/logo.png';
      var txt=document.createElement('div');txt.innerHTML='<div style="font-weight:900">'+g.name+'</div><div style="font-size:12px;color:var(--muted)">'+(g.description||'')+'</div>';
      left.appendChild(img);left.appendChild(txt);
      var right=document.createElement('div');right.innerHTML='<div style="font-weight:800">'+(g.member_count||0)+' members</div>';
      card.appendChild(left);card.appendChild(right);
      card.addEventListener('click',function(id){return function(){location.href='/web/group.html?id='+id}}(g.id));
      wrap.appendChild(card);
    }
  }
  await refreshGroups();
  var createBtn=document.getElementById('createBtn');
  async function updateUser(){userRow=await getUser();document.getElementById('createFeedback').innerText='';}
  createBtn.addEventListener('click',async function(){
    var name=document.getElementById('groupName').value.trim();
    if(!name){document.getElementById('createFeedback').innerText='Enter group name';return}
    userRow=await getUser();
    var balance=(userRow&&typeof userRow.balance!=='undefined')?Number(userRow.balance):0;
    if(balance<100){document.getElementById('createFeedback').innerText='Insufficient balance';return}
    var ins=await sb.from('groups').insert([{creator_id:userRow.id,name:name,description:'',member_count:1,cost:100}]).select().maybeSingle();
    if(ins.error||!ins.data){document.getElementById('createFeedback').innerText='Failed to create group';return}
    var upd=await sb.from('users').update({balance:balance-100}).eq('id',userRow.id);
    await sb.from('group_members').insert([{group_id:ins.data.id,user_id:userRow.id}]);
    await refreshGroups();
    await updateUser();
    document.getElementById('groupName').value='';
    document.getElementById('createFeedback').innerText='Group created';
  });
  window.addEventListener('resize',function(){if(window.innerWidth>=1000)sidebar.classList.remove('open')});
});
</script>
</body>
</html>
