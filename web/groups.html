<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Groups - OLDRBX</title>
<link rel="icon" href="/img/ic.png">
<style>
:root{--bg:#efefef;--panel:#ffffff;--muted:#666;--border:#d7d7d7;--accent:#111}
html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#111}
.topbar{height:56px;background:var(--accent);display:flex;align-items:center;padding:0 12px;gap:12px;box-sizing:border-box}
.hamburger{width:44px;height:44px;border-radius:6px;border:none;background:transparent;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.logo-img{height:32px}
.top-right{margin-left:auto;display:flex;align-items:center;gap:12px}
.money-wrap{display:flex;align-items:center;gap:8px;color:#fff;font-weight:800}
.money-wrap img{width:20px;height:20px}
.balance{font-weight:800;color:#fff}
.avatar{width:36px;height:36px;border-radius:6px;overflow:hidden;background:#fff;display:inline-block}
.avatar img{width:100%;height:100%;object-fit:cover}
.container{max-width:1100px;margin:20px auto;padding:0 16px;box-sizing:border-box}
.layout{display:grid;grid-template-columns:300px 1fr;gap:18px;align-items:start}
.sidebar{background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:6px;min-height:320px}
.user-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.user-header .mini{width:44px;height:44px;border-radius:6px;overflow:hidden}
.user-header .mini img{width:100%;height:100%;object-fit:cover}
#sideName{font-weight:900;} 
.nav-item{padding:12px;border-radius:6px;background:#fff;border:1px solid var(--border);font-weight:800;margin-bottom:10px;cursor:pointer}
.main{background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:6px}
.section-title{font-weight:900;margin-bottom:8px}
.group-card{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;background:#fff;cursor:pointer}
.group-left{display:flex;align-items:center;gap:10px}
.group-left img{width:60px;height:60px;border-radius:6px;object-fit:cover}
.create-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
input[type="text"]{padding:8px;border:1px solid var(--border);border-radius:6px}
.btn{padding:8px 12px;border-radius:6px;border:none;font-weight:800;cursor:pointer}
.btn-create{background:var(--accent);color:#fff}
.btn-disabled{background:#fff;border:1px solid var(--border);color:#999;cursor:not-allowed}
.empty{color:var(--muted);padding:12px;text-align:center}
.footer{margin-top:18px;background:var(--panel);border-top:1px solid var(--border);padding:10px 16px;color:var(--muted);font-weight:700;border-radius:0;text-align:center}
@media(max-width:1000px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;left:-360px;top:56px;height:calc(100% - 56px);width:280px;z-index:1200;transition:left .18s ease}.sidebar.open{left:0}}
</style>
</head>
<body>
<div class="topbar">
  <button id="hamb" class="hamburger" aria-label="menu">&#9776;</button>
  <img src="/img/logo.png" class="logo-img" alt="logo">
  <div class="top-right">
    <div class="money-wrap" title="Balance">
      <img id="moneyIcon" src="/img/money.png" alt="money">
      <div id="balanceText" class="balance">0</div>
    </div>
    <a id="topAvatar" class="avatar" href="/web/home.html"><img id="topAv" src="/img/user.png" alt="avatar"></a>
  </div>
</div>
<div class="container">
  <div class="layout">
    <aside id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="user-header">
        <div class="mini"><img id="sideAv" src="/img/user.png" alt=""></div>
        <div><div id="sideName" class="username">User</div></div>
      </div>
      <div class="nav-item" data-h="/web/home.html">Home</div>
      <div class="nav-item" data-h="/web/friends.html">Friends</div>
      <div class="nav-item" data-h="/web/groups.html">Groups</div>
      <div class="nav-item" data-h="/web/forums.html">Forums</div>
      <div class="nav-item" data-h="/web/users.html">Users</div>
    </aside>
    <main class="main" role="main">
      <div>
        <div class="section-title">Create Group (Cost: 100)</div>
        <div class="create-row">
          <input id="groupName" type="text" placeholder="Group name">
          <button id="createBtn" class="btn btn-create">Create</button>
        </div>
        <div id="createFeedback" class="empty"></div>
      </div>
      <div style="margin-top:14px">
        <div class="section-title">Popular Groups</div>
        <div id="groupsList"></div>
      </div>
    </main>
  </div>
  <div class="footer">Â© 2026 OLDRBX</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
  const SUPA_URL = "https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnNuanVrdGZobWVneXpla2siLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc2ODY2NDkxMiwiZXhwIjoyMDg0MjQwOTEyfQ.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

  const hamb = document.getElementById('hamb'), sidebar = document.getElementById('sidebar');
  hamb.addEventListener('click', ()=>{ if(window.innerWidth<1000) sidebar.classList.toggle('open'); });
  document.querySelectorAll('.nav-item').forEach(it => it.addEventListener('click', ()=> location.href = it.dataset.h));

  let auth = null;
  try { auth = JSON.parse(localStorage.getItem('auth')); } catch(e){ auth=null; }
  if(!auth || !auth.username){ location.replace('login.html'); return; }

  document.getElementById('sideName').innerText = auth.username;
  function safeSrc(u){ return u ? u : '/img/user.png'; }
  function setAv(u){ let x = safeSrc(u); document.getElementById('sideAv').src=x; document.getElementById('topAv').src=x; }
  setAv(auth.avatarUrl);

  async function getUser(){
    try{
      const res = await sb.from('users').select('*').eq('username', auth.username).maybeSingle();
      return res.data || null;
    } catch(e){ return null; }
  }

  let userRow = await getUser();
  if(userRow){
    if(userRow.balance!==undefined) document.getElementById('balanceText').innerText = String(userRow.balance);
    if(userRow.avatar_url) setAv(userRow.avatar_url);
    try{ await sb.from('users').update({last_active: new Date().toISOString()}).eq('id', userRow.id); }catch(e){}
  }

  async function refreshGroups(){
    const wrap = document.getElementById('groupsList');
    wrap.innerHTML='';
    try{
      const res = await sb.from('groups')
        .select('id,name,description,image_url,member_count')
        .order('member_count',{ascending:false});
      console.log('Groups fetch:', res);
      if(res.error || !res.data || !res.data.length){ wrap.innerHTML='<div class="empty">No groups yet</div>'; return; }
      for(const g of res.data){
        const card = document.createElement('div'); card.className='group-card';
        const left = document.createElement('div'); left.className='group-left';
        const img = document.createElement('img'); img.src=g.image_url||'/img/logo.png';
        const txt = document.createElement('div');
        txt.innerHTML=`<div style="font-weight:900">${g.name}</div><div style="font-size:12px;color:var(--muted)">${g.description||''}</div>`;
        left.appendChild(img); left.appendChild(txt);
        const right = document.createElement('div'); right.innerHTML=`<div style="font-weight:800">${g.member_count||0} members</div>`;
        card.appendChild(left); card.appendChild(right);
        card.addEventListener('click', ()=> location.href='/web/group.html?id='+g.id);
        wrap.appendChild(card);
      }
    }catch(e){ wrap.innerHTML='<div class="empty">Error loading groups</div>'; }
  }

  await refreshGroups();

  document.getElementById('createBtn').addEventListener('click', async ()=>{
    const name = document.getElementById('groupName').value.trim();
    const feedback = document.getElementById('createFeedback'); feedback.innerText='';
    if(!name){ feedback.innerText='Enter group name'; return; }

    userRow = await getUser();
    const balance = userRow && userRow.balance ? Number(userRow.balance) : 0;
    if(balance<100){ feedback.innerText='Insufficient balance'; return; }

    try{
      const ins = await sb.from('groups').insert([{creator_id:userRow.id,name,description:'',member_count:1,cost:100}]).select().maybeSingle();
      if(ins.error||!ins.data){ feedback.innerText='Failed to create group'; return; }
      await sb.from('group_members').insert([{group_id:ins.data.id,user_id:userRow.id}]);
      await sb.from('users').update({balance:balance-100}).eq('id',userRow.id);
      document.getElementById('groupName').value='';
      feedback.innerText='Group created';
      document.getElementById('balanceText').innerText=String(balance-100);
      await refreshGroups();
    }catch(e){ feedback.innerText='Failed to create group'; }
  });

  window.addEventListener('resize', ()=>{ if(window.innerWidth>=1000) sidebar.classList.remove('open'); });
});
</script>
</body>
</html>