<!doctype html>
<html lang="en" class="h-100">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forums - OLDRBX</title>
<link rel="icon" type="image/png" href="img/ic.png">
<style>
:root{
  --bg:#f0f4f8;
  --panel:#ffffff;
  --border:#d7dbe0;
  --muted:#6b7280;
  --accent:#3b6ea5;
  --text:#0f1724;
  --radius:4px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
.header{height:64px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:8px}
.brand{display:flex;align-items:center;gap:6px}
.hamburger{width:44px;height:44px;border-radius:4px;border:none;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0}
.hamburger .bar{display:block;width:22px;height:2px;background:var(--text);box-shadow:0 7px 0 0 var(--text),0 -7px 0 0 var(--text);border-radius:1px}
.logo{height:36px}
.wrapper{display:flex;min-height:calc(100vh - 64px)}
.sidebar{width:220px;background:var(--panel);border-right:1px solid var(--border);padding:14px;display:flex;flex-direction:column;gap:8px;transition: left .18s ease}
.sidebar.open{left:0}
.menu{display:flex;flex-direction:column;gap:8px}
.menu a{display:block;padding:10px 12px;border-radius:6px;text-decoration:none;color:var(--text);font-weight:800;border:1px solid transparent;background:transparent}
.menu a.active{border-left:4px solid var(--accent);background:linear-gradient(180deg,rgba(59,110,165,0.06),transparent)}
.center{flex:1;padding:22px;display:flex;justify-content:center}
.card{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:16px;max-width:980px;width:100%}
.top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.topic{padding:16px;border-radius:6px;border:1px solid var(--border);cursor:pointer;font-weight:900;display:flex;align-items:center;justify-content:center;min-height:88px;background:linear-gradient(180deg,#fff,#f7fbff)}
.topic:hover{box-shadow:0 8px 18px rgba(15,23,36,0.04)}
.topic-count{font-weight:800;color:var(--muted)}
.topic-view{display:none;flex-direction:column;gap:12px}
.posts{display:flex;flex-direction:column;gap:12px;max-height:420px;overflow:auto;padding-right:6px}
.post{display:flex;gap:12px;padding:12px;border-radius:6px;border:1px solid var(--border);align-items:flex-start;background:#fff}
.post .avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;border:1px solid var(--border)}
.post .avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.post .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
.composer{display:flex;gap:10px;align-items:flex-start;margin-top:12px}
.textarea{flex:1;min-height:90px;border:1px solid var(--border);border-radius:6px;padding:10px;background:#fff}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:6px;font-weight:800;cursor:pointer}
.back{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:6px;color:var(--text);font-weight:800;cursor:pointer}
.empty{color:var(--muted);padding:18px;text-align:center}
.footer{padding:14px;text-align:center;color:var(--muted);border-top:1px solid var(--border);background:var(--panel)}
@media(max-width:900px){
  .hamburger{display:flex}
  .sidebar{position:fixed;left:-320px;top:64px;height:calc(100% - 64px);z-index:1200}
  .sidebar.open{left:0}
  .center{padding:12px}
}
@media(min-width:901px){
  .hamburger{display:none}
  .sidebar{position:relative;left:0}
}
</style>
</head>
<body>
<header class="header">
  <div class="brand">
    <button id="hamb" class="hamburger" aria-label="menu"><span class="bar"></span></button>
    <img src="img/logo.png" class="logo" alt="logo">
  </div>
  <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
    <div style="width:36px;height:36px;border-radius:50%;overflow:hidden;border:1px solid var(--border)"><img id="topAv" src="img/user.png" style="width:36px;height:36px;border-radius:50%" alt="avatar"></div>
  </div>
</header>
<div class="wrapper">
  <aside id="sidebar" class="sidebar">
    <nav class="menu">
      <a href="home-paid.html" id="mhome" class="">Home</a>
      <a href="forums-paid.html" id="mforums" class="active">Forums</a>
    </nav>
  </aside>
  <main class="center">
    <div class="card" id="topicsCard">
      <div class="top-row">
        <div style="font-weight:900;font-size:16px">Forums</div>
        <div class="topic-count" id="topicCount">0 topics</div>
      </div>
      <div id="topicsArea" class="topic-grid"></div>
      <div id="topicEmpty" class="empty" style="display:none">No topics yet.</div>
    </div>
    <div class="card topic-view" id="topicView">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:12px;align-items:center">
          <button id="backBtn" class="back">Back</button>
          <div id="topicTitle" style="font-weight:900"></div>
        </div>
        <div id="postCount" style="color:var(--muted)"></div>
      </div>
      <div id="postsWrap" class="posts"></div>
      <div id="composer" class="composer" style="display:none">
        <div style="width:48px;height:48px;border-radius:50%;overflow:hidden;border:1px solid var(--border)"><img id="meAv" src="img/user.png" style="width:48px;height:48px;border-radius:50%" alt="avatar"></div>
        <div style="flex:1">
          <div id="meName" style="font-weight:900;margin-bottom:6px"></div>
          <textarea id="msgInput" class="textarea" placeholder="Write your message..."></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<div class="footer">&copy; 2026 OLDRBX</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function(){
  const SUPA_URL = "https://nkvvnnjukqtfhmegyzek.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdnZubmp1a3F0ZmhtZWd5emVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQ5MTIsImV4cCI6MjA4NDI0MDkxMn0.2jp9X2KQunFargrstYM7oGBYs75Kq7AEHs7iRARxexs";
  const sb = supabase.createClient(SUPA_URL, SUPA_KEY);
  let currentTopic = null;
  let currentTopicId = null;
  let auth = null;
  try{ auth = JSON.parse(localStorage.getItem('auth')) }catch(e){ auth = null }
  if(!auth||!auth.username){ location.replace('login.html'); return }
  document.getElementById('meName').innerText = auth.username
  document.getElementById('meAv').src = auth.avatarUrl || 'img/user.png'
  document.getElementById('topAv').src = auth.avatarUrl || 'img/user.png'
  document.getElementById('hamb').addEventListener('click', function(){ var s=document.getElementById('sidebar'); if(s) s.classList.toggle('open') })
  async function ensureDefaults(){
    const { data } = await sb.from('forum_topics').select('*').order('id',{ascending:true})
    if(!data || !data.length){
      const defaults = [
        { slug:'news', title:'News' },
        { slug:'updates', title:'Updates' },
        { slug:'whats-on-your-mind', title:"What's on your mind" }
      ]
      for(const d of defaults) await sb.from('forum_topics').insert(d).select().maybeSingle()
    }
  }
  async function loadTopics(){
    await ensureDefaults()
    const { data, error } = await sb.from('forum_topics').select('*').order('id',{ascending:true})
    const area = document.getElementById('topicsArea')
    area.innerHTML = ''
    if(!data || !data.length){ document.getElementById('topicEmpty').style.display='block'; document.getElementById('topicCount').innerText='0 topics'; return }
    document.getElementById('topicEmpty').style.display='none'
    document.getElementById('topicCount').innerText = data.length + ' topics'
    data.forEach(t=>{
      const el = document.createElement('div')
      el.className = 'topic'
      el.textContent = t.title
      el.dataset.slug = t.slug
      el.dataset.id = t.id
      el.addEventListener('click', function(){ openTopic(t) })
      area.appendChild(el)
    })
  }
  async function openTopic(t){
    currentTopic = t.slug
    currentTopicId = t.id
    document.getElementById('topicTitle').innerText = t.title
    document.getElementById('topicsCard').style.display = 'none'
    document.getElementById('topicView').style.display = 'flex'
    document.getElementById('composer').style.display = 'none'
    await loadPosts(currentTopicId)
    document.getElementById('composer').style.display = 'flex'
  }
  async function loadPosts(topicId){
    const { data:posts } = await sb.from('forum_posts').select('*').eq('topic_id',topicId).order('created_at',{ascending:true})
    const wrap = document.getElementById('postsWrap')
    wrap.innerHTML = ''
    const count = (posts && posts.length) ? posts.length : 0
    document.getElementById('postCount').innerText = count + ' messages'
    if(!posts || !posts.length){ wrap.innerHTML = '<div class="empty">No posts yet. Be the first to post.</div>'; return }
    posts.forEach(p=>{
      const d = document.createElement('div'); d.className='post'
      const av = document.createElement('div'); av.className='avatar'
      const img = document.createElement('img')
      img.src = (p.avatar_url && p.avatar_url.indexOf('http')===0) ? p.avatar_url : 'img/' + (p.avatar_url || 'user.png')
      av.appendChild(img)
      const body = document.createElement('div'); body.style.flex='1'
      const meta = document.createElement('div'); meta.className='meta'
      const created = p.created_at ? new Date(p.created_at).toLocaleString() : ''
      meta.textContent = (p.username||'Unknown') + ' â€¢ ' + created
      const msg = document.createElement('div'); msg.textContent = p.content
      body.appendChild(meta); body.appendChild(msg)
      d.appendChild(av); d.appendChild(body)
      wrap.appendChild(d)
    })
    wrap.scrollTop = wrap.scrollHeight
  }
  document.getElementById('backBtn').addEventListener('click', function(){
    document.getElementById('topicView').style.display = 'none'
    document.getElementById('topicsCard').style.display = 'block'
    document.getElementById('topicTitle').innerText = ''
    document.getElementById('postsWrap').innerHTML = ''
    document.getElementById('composer').style.display = 'none'
  })
  document.getElementById('sendBtn').addEventListener('click', async function(){
    const txt = document.getElementById('msgInput').value.trim()
    if(!txt || !currentTopicId) return
    const payload = { topic_id: currentTopicId, username: auth.username, content: txt, avatar_url: auth.avatarUrl || 'user.png' }
    const { error } = await sb.from('forum_posts').insert(payload)
    if(error) return
    document.getElementById('msgInput').value = ''
    await loadPosts(currentTopicId)
  })
  await loadTopics()
})
</script>
</body>
</html>
